<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ELEEVA – Preventivi Cantiere</title>

  <!-- GOOGLE API -->
  <script src="https://apis.google.com/js/api.js"></script>

  <style>
    :root {
      --bg:#020015;
      --card:#040017;
      --muted:#595C60;
      --acc:#6CA85E;
      --text:#e5e7eb;
    }

    body{
      margin:0;
      font-family:system-ui;
      background:var(--bg);
      color:var(--text);
    }

    header{
      text-align:center;
      padding:20px;
    }

    header img{
      max-height:70px;
      margin-bottom:10px;
    }

    .wrap{
      max-width:900px;
      margin:auto;
      padding:16px;
    }

    .card{
      background:var(--card);
      padding:20px;
      border-radius:16px;
    }

    input{
      width:100%; padding:10px; border-radius:8px;
      border:1px solid #333;
      background:#fff;
    }

    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-bottom:12px;
    }

    button{
      padding:12px 20px;
      border:none;
      border-radius:10px;
      background:var(--acc);
      font-weight:bold;
      cursor:pointer;
      margin-top:10px;
    }

    .sheet{
      background:#fff;
      color:#000;
      padding:16px;
      border-radius:12px;
      margin-top:20px;
    }
    .photo{background:#eee;min-height:160px;display:flex;align-items:center;justify-content:center;border-radius:10px;}

  </style>
</head>
<body>

<header>
  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABB0AAAM4CAYAAACAw5qVAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABAtp..." />
  <h1>ELEEVA SRL</h1>
  <div>Preventivo rapido per cantiere</div>
</header>

<div class="wrap">
  <div class="card">

    <!-- LOGIN GOOGLE -->
    <button onclick="googleLogin()" id="loginBtn">Accedi con Google</button>
    <div id="userInfo" style="margin:10px 0;display:none;">✅ Connesso come: <b id="userEmail"></b></div>

    <form id="form">
      <div class="row">
        <div><label>Nome condominio</label><input id="condominio" required></div>
        <div><label>Luogo</label><input id="luogo" required></div>
      </div>

      <h3>Ponteggio</h3>
      <div class="row">
        <div><label>Perimetro (m)</label><input id="ponteggio_p" type="number" min="0" step="0.01" required></div>
        <div><label>Altezza (m)</label><input id="ponteggio_h" type="number" min="0" step="0.01" required></div>
      </div>

      <h3>Cappotto</h3>
      <div class="row">
        <div><label>Perimetro (m)</label><input id="cappotto_p" type="number" min="0" step="0.01" required></div>
        <div><label>Altezza (m)</label><input id="cappotto_h" type="number" min="0" step="0.01" required></div>
      </div>

      <div class="row">
        <div><label>N° finestre</label><input id="finestre" type="number" min="0" required></div>
        <div><label>N° unità immobiliari</label><input id="unita" type="number" min="1" required></div>
      </div>

      <label>Foto edificio</label>
      <input id="foto" type="file" accept="image/*" capture="environment">

      <button type="submit">Genera PDF e salva in Drive</button>
    </form>

    <div class="sheet" id="sheet">
      <h2 id="s_title">—</h2>
      <div id="s_sub">—</div>
      <div class="photo" id="photoBox">Nessuna foto</div>
      <p>Ponteggio (mq): <b id="s_ponteggio">0</b></p>
      <p>Cappotto (mq): <b id="s_cappotto">0</b></p>
      <p>Finestre: <b id="s_finestre">0</b></p>
      <p>Unità: <b id="s_unita">0</b></p>
      <h3>Totale: <span id="s_totale">€ 0,00</span></h3>
      <h4>A partire da <span id="s_unitario">€ 0,00</span> / unità</h4>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
// ============= GOOGLE DRIVE CONFIG =============
const API_KEY = "AIzaSyCzEJEtwn4R7yuoLUOiPrs5CGhTC6-5rq0";
const CLIENT_ID = "523209491137-45pgt1m2rq7dhucd9bds0gkqe0er0v1v.apps.googleusercontent.com";
const SCOPES = 'https://www.googleapis.com/auth/drive.file';
let GoogleUser = null;

function googleLogin(){
  gapi.load('client:auth2', async ()=>{
    await gapi.client.init({ apiKey:API_KEY, clientId:CLIENT_ID, scope:SCOPES });
    gapi.auth2.getAuthInstance().signIn().then(user=>{
      GoogleUser=user;
      document.getElementById('userEmail').textContent=user.getBasicProfile().getEmail();
      document.getElementById('userInfo').style.display='block';
    });
  });
}

// UPLOAD SU DRIVEsync function uploadToDrive(file){
  const accessToken = gapi.auth.getToken().access_token;

  const metadata = { name:file.name, mimeType:file.type, parents:[] };

  const form = new FormData();
  form.append('metadata', new Blob([JSON.stringify(metadata)], {type:'application/json'}));
  form.append('file', file);

  const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',{
    method:'POST',
    headers:{ 'Authorization':'Bearer ' + accessToken },
    body:form
  });
  return await res.json();
}

// ============= LOGICA CALCOLI =============
const EURO = n => new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(n);
const $ = id => document.getElementById(id);
let foto64 = null;

$('foto').addEventListener('change', e => {
  const f = e.target.files[0];
  if(!f){ foto64=null; return; }
  const r = new FileReader();
  r.onload = x => {
    foto64 = x.target.result;
    $('photoBox').innerHTML = '<img src="'+foto64+'" style="max-width:100%">';
  };
  r.readAsDataURL(f);
});

function calc(){
  const ponteggio = parseFloat($('ponteggio_p').value||0) * parseFloat($('ponteggio_h').value||0);
  const cappotto  = parseFloat($('cappotto_p').value||0) * parseFloat($('cappotto_h').value||0);
  const finestre = parseInt($('finestre').value||0);
  const unita = parseInt($('unita').value||1);
  const tot = (ponteggio*16)+(cappotto*80)+(finestre*350)+3000;
  return {ponteggio,cappotto,finestre,unita,tot,unitario:tot/unita};
}

function update(){
  const o = calc();
  $('s_title').textContent = $('condominio').value;
  $('s_sub').textContent   = $('luogo').value;
  $('s_ponteggio').textContent = o.ponteggio;
  $('s_cappotto').textContent  = o.cappotto;
  $('s_finestre').textContent  = o.finestre;
  $('s_unita').textContent     = o.unita;
  $('s_totale').textContent    = EURO(o.tot);
  $('s_unitario').textContent  = EURO(o.unitario);
}

$('form').addEventListener('input', update);

// ============= GENERA PDF + UPLOAD =============
$('form').addEventListener('submit', async e =>{
  e.preventDefault();
  update();
  const pdfFile = await generaPDF();
  const jsonFile = generaJSON();

  if(!GoogleUser){ alert('Devi accedere con Google prima di salvare in Drive'); return; }

  await uploadToDrive(pdfFile);
  await uploadToDrive(jsonFile);

  alert('✅ Salvato su Drive con successo!');
});

async function generaPDF(){
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();
  const o=calc();

  // HEADER COLORATO + LOGO
  doc.setFillColor(108,168,94);
  doc.rect(0,0,210,25,'F');
  doc.setTextColor(255,255,255);
  doc.setFontSize(16);
  doc.text('ELEEVA SRL',10,15);

  try{
    doc.addImage("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABB0AAAM4CAYAAACAw5qVAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABAtp...","PNG",160,5,40,12);
  }catch{}

  doc.setTextColor(0,0,0);
  doc.setFontSize(14);
  doc.text($('condominio').value,10,40);
  doc.setFontSize(11);
  doc.text($('luogo').value,10,48);

  if(foto64){ doc.addImage(foto64,'JPEG',10,55,80,60); }

  doc.setFontSize(12);
  doc.text('Ponteggio (mq): '+o.ponteggio,110,60);
  doc.text('Cappotto (mq): '+o.cappotto,110,72);
  doc.text('Finestre: '+o.finestre,110,84);
  doc.text('Unità: '+o.unita,110,96);

  doc.setFontSize(14);
  doc.text('Totale: '+EURO(o.tot),10,130);
  doc.text('A partire da '+EURO(o.unitario)+' / unità',10,140);

  const pdfBlob = doc.output('blob');
  return new File([pdfBlob], 'preventivo.pdf', {type:'application/pdf'});
}

function generaJSON(){
  const o=calc();
  const data={
    condominio:$('condominio').value,
    luogo:$('luogo').value,
    ...o,
    foto:foto64
  };
  return new File([JSON.stringify(data,null,2)], 'preventivo.json', {type:'application/json'});
}
</script>

</body>
</html>
