<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ELEEVA – Preventivi Cantiere</title>

<!-- Librerie Google Identity Services + API -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
  body{font-family:system-ui;background:#fff;color:#111;margin:0}
  header{text-align:center;padding:16px;border-bottom:1px solid #ddd}
  .wrap{max-width:960px;margin:auto;padding:16px}
  input,button{padding:10px;border-radius:8px;border:1px solid #ccc;width:100%}
  button{background:#6CA85E;color:#fff;font-weight:bold;border:none;cursor:pointer}
  .sheet{background:#fafafa;border:1px solid #eee;border-radius:12px;padding:16px;margin-top:16px}
  .photo{min-height:200px;background:#eee;display:flex;align-items:center;justify-content:center;border-radius:8px;overflow:hidden}
</style>
</head>

<body>
<header>
  <h1>ELEEVA SRL</h1>
  <div>Via dell'Industria n° 29 – 36071 Arzignano (VI)</div>
  <div>info@eleeva.it</div>
</header>

<div class="wrap">
  <button id="loginBtn">Accedi con Google</button>
  <div id="userInfo" style="display:none">✅ Connesso come <b id="userEmail"></b></div>

  <form id="form" style="margin-top:20px">
    <label>Nome condominio</label>
    <input id="condominio" required />
    <label>Luogo</label>
    <input id="luogo" required />
    <label>Perimetro ponteggio (m)</label>
    <input id="ponteggio_p" type="number" step="0.01" />
    <label>Altezza ponteggio (m)</label>
    <input id="ponteggio_h" type="number" step="0.01" />
    <label>Perimetro cappotto (m)</label>
    <input id="cappotto_p" type="number" step="0.01" />
    <label>Altezza cappotto (m)</label>
    <input id="cappotto_h" type="number" step="0.01" />
    <label>N° finestre</label>
    <input id="finestre" type="number" />
    <label>N° unità</label>
    <input id="unita" type="number" />
    <label>Foto edificio</label>
    <input id="foto" type="file" accept="image/*" capture="environment" />
    <button type="submit" style="margin-top:12px">Genera e salva</button>
  </form>

  <div class="sheet" id="sheet">
    <h2 id="s_title">—</h2>
    <div id="s_sub">—</div>
    <div class="photo" id="photoBox">Nessuna foto</div>
  </div>
</div>

<script>
// === CONFIGURAZIONE GOOGLE ===
const CLIENT_ID = "523209491137-45pgt1m2rq7dhucd9bds0gkqe0er0v1v.apps.googleusercontent.com"; // <-- Inserisci qui il tuo ID
const API_KEY = "";
const SCOPES = "https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets";

let tokenClient, accessToken, gapiInited = false, gisInited = false;

// === Inizializza GAPI ===
function gapiLoaded() {
  gapi.load('client', initializeGapiClient);
}
async function initializeGapiClient() {
  await gapi.client.init({
    apiKey: API_KEY,
    discoveryDocs: [
      "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",
      "https://sheets.googleapis.com/$discovery/rest?version=v4"
    ],
  });
  gapiInited = true;
}
window.onload = function() {
  gapiLoaded();
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: (tokenResponse) => {
      accessToken = tokenResponse.access_token;
      document.getElementById("userInfo").style.display = "block";
      document.getElementById("userEmail").textContent = "(utente connesso)";
    },
  });
};

// === LOGIN ===
document.getElementById("loginBtn").onclick = () => {
  tokenClient.requestAccessToken({ prompt: "" });
};

// === CALCOLI ===
function calc() {
  const pP = parseFloat(document.getElementById("ponteggio_p").value) || 0;
  const pH = parseFloat(document.getElementById("ponteggio_h").value) || 0;
  const cP = parseFloat(document.getElementById("cappotto_p").value) || 0;
  const cH = parseFloat(document.getElementById("cappotto_h").value) || 0;
  const finestre = parseInt(document.getElementById("finestre").value) || 0;
  const unita = parseInt(document.getElementById("unita").value) || 1;
  const ponteggio = pP * pH;
  const cappotto = cP * cH;
  const tot = (ponteggio*16)+(cappotto*80)+(finestre*350)+3000;
  return { ponteggio, cappotto, finestre, unita, tot, unitario: tot/unita };
}
</script>
<script>
// === FOTO ===
let foto64 = null;
document.getElementById("foto").addEventListener("change", e => {
  const f = e.target.files[0];
  if (!f) return;
  const r = new FileReader();
  r.onload = ev => {
    foto64 = ev.target.result;
    const img = new Image();
    img.src = foto64;
    img.onload = () => {
      const box = document.getElementById("photoBox");
      box.innerHTML = "";
      box.appendChild(img);
    };
  };
  r.readAsDataURL(f);
});

// === GENERA PDF ===
async function generaPDF(dati) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFillColor(108,168,94);
  doc.rect(0,0,210,20,"F");
  doc.setTextColor(255,255,255);
  doc.setFontSize(12);
  doc.text("ELEEVA SRL",10,13);

  doc.setTextColor(0,0,0);
  doc.setFontSize(14);
  doc.text(dati.condominio,10,35);
  doc.setFontSize(11);
  doc.text(dati.luogo,10,43);

  if(foto64) doc.addImage(foto64,"JPEG",10,50,90,60);

  doc.text("Ponteggio (mq): "+dati.ponteggio,110,60);
  doc.text("Cappotto (mq): "+dati.cappotto,110,70);
  doc.text("Finestre: "+dati.finestre,110,80);
  doc.text("Unità: "+dati.unita,110,90);
  doc.text("Totale: €"+dati.tot.toLocaleString("it-IT"),10,130);
  doc.text("A partire da €"+dati.unitario.toLocaleString("it-IT")+" / unità",10,140);

  const blob = doc.output("blob");
  return new File([blob], "preventivo.pdf", { type: "application/pdf" });
}

// === UPLOAD DRIVE ===
async function uploadFileToDrive(file, folderId) {
  const metadata = {
    name: file.name,
    mimeType: file.type,
    parents: [folderId],
  };
  const form = new FormData();
  form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
  form.append("file", file);
  const res = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
    method: "POST",
    headers: new Headers({ Authorization: "Bearer " + accessToken }),
    body: form,
  });
  return await res.json();
}

// === CREA CARTELLA ELEEVA_PREVENTIVI SE NON ESISTE ===
async function getOrCreateFolder() {
  const res = await gapi.client.drive.files.list({
    q: "mimeType='application/vnd.google-apps.folder' and name='ELEEVA_PREVENTIVI' and trashed=false",
    fields: "files(id,name)",
  });
  if (res.result.files.length) return res.result.files[0].id;
  const create = await gapi.client.drive.files.create({
    resource: { name: "ELEEVA_PREVENTIVI", mimeType: "application/vnd.google-apps.folder" },
    fields: "id",
  });
  return create.result.id;
}

// === CREA O OTTIENI IL FOGLIO GOOGLE ===
async function getOrCreateSheet(folderId) {
  const res = await gapi.client.drive.files.list({
    q: "mimeType='application/vnd.google-apps.spreadsheet' and name='Preventivi_ELEEVA' and trashed=false and '"+folderId+"' in parents",
    fields: "files(id,name)",
  });
  if (res.result.files.length) return res.result.files[0].id;
  const create = await gapi.client.drive.files.create({
    resource: { name: "Preventivi_ELEEVA", mimeType: "application/vnd.google-apps.spreadsheet", parents: [folderId] },
    fields: "id",
  });
  const sheetId = create.result.id;
  await gapi.client.sheets.spreadsheets.values.update({
    spreadsheetId: sheetId,
    range: "A1:I1",
    valueInputOption: "RAW",
    values: [["Data","Condominio","Luogo","Ponteggio (mq)","Cappotto (mq)","Finestre","Unità","Totale (€)","Prezzo unitario (€)"]],
  });
  return sheetId;
}

// === AGGIUNGI RIGA AL FOGLIO ===
async function appendRow(sheetId, dati) {
  const now = new Date().toLocaleString("it-IT");
  await gapi.client.sheets.spreadsheets.values.append({
    spreadsheetId: sheetId,
    range: "A:I",
    valueInputOption: "USER_ENTERED",
    insertDataOption: "INSERT_ROWS",
    resource: {
      values: [[now, dati.condominio, dati.luogo, dati.ponteggio, dati.cappotto, dati.finestre, dati.unita, dati.tot, dati.unitario]],
    },
  });
}

// === SUBMIT ===
document.getElementById("form").addEventListener("submit", async e => {
  e.preventDefault();
  const d = calc();
  const record = {
    condominio: document.getElementById("condominio").value,
    luogo: document.getElementById("luogo").value,
    ...d
  };
  localStorage.setItem("ultimoPreventivo", JSON.stringify(record));
  const pdf = await generaPDF(record);
  const json = new File([JSON.stringify(record,null,2)], "preventivo.json", { type: "application/json" });

  const folderId = await getOrCreateFolder();
  const sheetId = await getOrCreateSheet(folderId);

  await uploadFileToDrive(pdf, folderId);
  await uploadFileToDrive(json, folderId);
  await appendRow(sheetId, record);

  alert("✅ Salvato su Drive e registrato su Google Sheet!");
});

// === RIPRISTINO DATI LOCALI ===
window.addEventListener("DOMContentLoaded", () => {
  const rec = JSON.parse(localStorage.getItem("ultimoPreventivo")||"null");
  if(rec){
    for(const k in rec){
      const el = document.getElementById(k);
      if(el) el.value = rec[k];
    }
  }
});
</script>
</body>
</html>
